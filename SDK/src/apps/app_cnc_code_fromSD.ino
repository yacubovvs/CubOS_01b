/*
 * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 
 * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
 * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
 *                                                                                         *
 *                                                                                         *
 *                                  >>>   IMPORTANT!   <<<                                 *
 *                   DO NOT FORGET TO ADD YOU APP IN os_applications.ino                   *
 *                                                                                         *
 *                                                                                         *
 * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 
 * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
 * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
 */

#define appNameClass    CNCCodeFromSD         // App name without spaces
#define appName         "SDCard"      // App name with spaces 

class appNameClass: public Application{
    public:

        long currentPosition = 0;
        bool fileOpened = false;
        String string = "";
        char c1 = 0;

        virtual void loop() override{
            /*
            * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 
            * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
            *                                                                                         *
            *                                >>>   MAIN APP LOOP   <<<                                *
            *                                                                                         *
            */

            //EVERY FRAME CODE
            if(!fileOpened){
                if(driver_sdcard_init()){

                    os_openFile("/code.lcode");
                    if (!os_seekFile(0) || !os_fileIsAvailable()){
                      drawString("File not available",0,0);  
                    }else{ 
                      fileOpened = true;  
                      readFileString();
                    }
                    
                }else{
                    drawString("SD card failed",0,0);
                    currentPosition = 0;
                }
            }else{
                drawString(string, 0, 0);

                if (isPressStart_Right()){
                  readFileString();
                }
            }


            #ifdef control_has_backbtn
              if (isPressStart_Select() || isPressStart_Back()){
                finish();
              }
            #else
              if (isPressStart_Select()){
                finish();
              }
            #endif

           /*                                                                                         *
            * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 
            * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
            */

        };

        void readFileString(){
          string = "";
          
          while(fileIsNotEnded()){
            char gotChar = os_readChar();
            if(gotChar==10) break;
            string += ((char)gotChar);
          }

          DeviceSerial.println(string);
        }

        void finish(){
          os_closeFile();
          os_switch_to_app(-1); // Go to the main menu
        }

        void setup(){
            /*
            * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 
            * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
            *                                                                                         *
            *                              >>>   APP SETUP ON START   <<<                             *
            *                                                                                         *
            */

            // ON START CODE
            #ifdef tabletView
                this->showStatusBar = true;
            #endif

           /*                                                                                         *
            * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 
            * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
            */
        };

        appNameClass(){ // Constructor
            setup();
        };

        const static byte icon[];

        static unsigned const char* getParams(unsigned char type){
            switch(type){ 
              case PARAM_TYPE_NAME: return (unsigned char*)appName; 
              case PARAM_TYPE_ICON: return icon;
              default: return (unsigned char*)""; }
        };

};

const byte appNameClass::icon[] PROGMEM = { //128
	//////////////////////////////////////////////////////////////
	//		PUT YOUR ICON HERE
  #ifdef colorScreen
    0x02,0x01,0x02,0x20,0x02,0x20,0x04,0xff,0xd9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0xA8,0x00,0x00,0x0A,0xA8,0x00,0x00,0x0A,0xA8,0x00,0x00,0x0A,0xA8,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x04,0xFF,0xFF,0xFF,0x1F,0xFF,0xFF,0xF8,0x3F,0xFF,0xFF,0xFC,0x7F,0xFF,0xFF,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xE0,0x01,0xFF,0xFF,0xC0,0x01,0xFF,0xFF,0xC0,0x01,0xFF,0xFF,0xC0,0x01,0xFF,0xFF,0xC0,0x01,0xFF,0xFF,0xC0,0x01,0xFF,0xFF,0xC0,0x01,
    0xFF,0xFF,0x80,0x01,0xFF,0xFF,0x00,0x01,0xFF,0xFE,0x00,0x01,0xFF,0xFE,0x00,0x01,0xFF,0xFE,0x00,0x01,0xFF,0xFF,0x80,0x01,0xFF,0xFF,0x80,
    0x01,0xFF,0xFF,0x00,0x01,0xFF,0xFE,0x00,0x01,0xFF,0xFE,0x00,0x01,0xFF,0xFE,0x00,0x01,0xFF,0xFE,0x00,0x01,0xFF,0xFE,0x00,0x01,0xFF,0xFF,
    0x00,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0xFF,0xFF,0xFE,0x3F,0xFF,0xFF,0xFC,0x1F,0xFF,0xFF,0xF8,
    0x04,0x8f,0x8f,0x8f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x15,0x54,0x00,0x00,0x15,0x54,0x00,0x00,0x15,0x54,0x00,0x00,0x15,0x54,0x00,0x00,0x1F,0xFC,0x00,0x00,0x1F,0xFC,0x00,0x00,0x3F,
    0xFC,0x00,0x00,0x7F,0xFC,0x00,0x00,0xFF,0xFC,0x00,0x00,0xFF,0xFC,0x00,0x00,0x3F,0xFC,0x00,0x00,0x3F,0xFC,0x00,0x00,0x3F,0xFC,0x00,0x00,
    0x7F,0xFC,0x00,0x00,0xFF,0xFC,0x00,0x00,0xFF,0xFC,0x00,0x00,0xFF,0xFC,0x00,0x00,0xFF,0xFC,0x00,0x00,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xFE,0x00,0x00,0x20,
    0x02,0x00,0x00,0x20,0x02,0x00,0x00,0x20,0x02,0x00,0x00,0x20,0x02,0x00,0x00,0x20,0x02,0x00,0x00,0x20,0x02,0x00,0x00,0x40,0x02,0x00,0x00,
    0x80,0x02,0x00,0x01,0x00,0x02,0x00,0x01,0x00,0x02,0x00,0x01,0xC0,0x02,0x00,0x00,0x40,0x02,0x00,0x00,0x40,0x02,0x00,0x00,0x80,0x02,0x00,
    0x01,0x00,0x02,0x00,0x01,0x00,0x02,0x00,0x01,0x00,0x02,0x00,0x01,0x00,0x02,0x00,0x01,0x00,0x02,0x00,0x00,0xFF,0xFC,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  #else
    0x02,0x01,0x02,0x20,0x02,0x20,0x04,0x00,0x00,0x00,0x1F,0xFF,0xFF,0xF8,0x20,0x00,0x00,0x04,0x40,0x00,0x00,0x02,0x80,0x00,0x00,0x01,0x80,
    0x00,0x00,0x01,0x80,0x1F,0xFE,0x01,0x80,0x35,0x56,0x01,0x80,0x35,0x56,0x01,0x80,0x35,0x56,0x01,0x80,0x35,0x56,0x01,0x80,0x3F,0xFE,0x01,
    0x80,0x3F,0xFE,0x01,0x80,0x7F,0xFE,0x01,0x80,0xFF,0xFE,0x01,0x81,0xFF,0xFE,0x01,0x81,0xFF,0xFE,0x01,0x81,0xFF,0xFE,0x01,0x80,0x7F,0xFE,
    0x01,0x80,0x7F,0xFE,0x01,0x80,0xFF,0xFE,0x01,0x81,0xFF,0xFE,0x01,0x81,0xFF,0xFE,0x01,0x81,0xFF,0xFE,0x01,0x81,0xFF,0xFE,0x01,0x81,0xFF,
    0xFE,0x01,0x80,0xFF,0xFC,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x01,0x40,0x00,0x00,0x02,0x20,0x00,0x00,0x04,0x1F,
    0xFF,0xFF,0xF8,
  #endif
	//
	//////////////////////////////////////////////////////////////
};