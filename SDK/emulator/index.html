<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Canvas в HTML5</title>
        <script type="text/javascript" src="assets/jquery-3.3.1.min.js"></script>
    </head>
    <body>
        <canvas id="myCanvas" width="1290" height="650"
            style="background-color:rgb(0, 0, 0); border:1px solid rgb(0, 0, 0);">
            Ваш браузер не поддерживает Canvas
        </canvas>

        <div class="btn-wrapper">
            <div class="btn" onmousedown="controll_buf[0]='1'" onmouseup="setTimeout(()=>{controll_buf[0]='0'},200);" >
                1
            </div><div class="btn" onmousedown="controll_buf[1]='1'" onmouseup="setTimeout(()=>{controll_buf[1]='0'},200);">
                2
            </div><div class="btn" onmousedown="controll_buf[2]='1'" onmouseup="setTimeout(()=>{controll_buf[2]='0'},200);">
                3
            </div>
        </div>

        <style>
            .btn{
                display: inline-block;
                width: calc(25% - 22px);
                border: 1px solid black ;
                padding: 10px;
                margin: 0 1%;
                text-align: center;
                user-select: none;
                background-color: white;
                cursor: pointer; 
                border-radius: 4px;
            }

            .btn-wrapper{
                text-align: center;
            }

            #myCanvas{
                width: calc(100% - 2px);
                height: auto;
                /*margin: 10px 0px;
                /*padding: 10px; */
            }

            body, html{
                background-color: rgb(68, 68, 68);
                padding: 0px;
                margin: 0px;
                height: 100%;
            }

            body{
                background-color: rgb(48, 48, 48);
                max-width: 700px;
                margin: auto;
                
            }
        </style>

        <script>

            var controll_buf=["0", "0", "0", "0", "0", "0", ];

            $(document).keydown(function(e) {
            switch (e.which) {
            case 37:
                // Left
                controll_buf[0]='1'
                setTimeout(()=>{controll_buf[0]='0'},200);
                break;
            case 38:
                // Down
                controll_buf[1]='1'
                setTimeout(()=>{controll_buf[1]='0'},200);
                break;
            case 39:
                // Right
                controll_buf[2]='1'
                setTimeout(()=>{controll_buf[2]='0'},200);
                break;
            case 40:
                // Top
                controll_buf[1]='1'
                setTimeout(()=>{controll_buf[1]='0'},200);
                break;
                }
            })

            var canvas = document.getElementById("myCanvas"), 
                context = canvas.getContext("2d");
            
            
            function drawPixel(x,y){
                context.beginPath();
                context.rect(x*10, y*10, 10, 10);
                context.fillStyle = "#b8fdff";
                context.strokeStyle = "#b8fdff";
                context.fill();
                context.stroke();
            }

            var screenBool = [];
            function drawScreenByHash(hash){
                context.clearRect(0, 0, canvas.width, canvas.height);

                var temp_c = 0;
                for (i in hash){ 
                    //console.log(hash[i]);
                    //console.log(i*4);
                    var b = get_boolBy_letterHash(hash[i]);
                    
                    x = (i*4 + 0)%128;
                    y = (i*4 + 0)/128;
                    if (b[0]) drawPixel(x,y);

                    x = (i*4 + 1)%128;
                    y = (i*4 + 1)/128;
                    if (b[1]) drawPixel(x,y);

                    x = (i*4 + 2)%128;
                    y = (i*4 + 2)/128;
                    if (b[2]) drawPixel(x,y);

                    x = (i*4 + 3)%128;
                    y = (i*4 + 3)/128;
                    if (b[3]) drawPixel(x,y);
                }

                
            }

            function get_boolBy_letterHash(letter){
                var temp_v = 0;
                switch(letter){
                    case "a": temp_v = 0; break;
                    case "b": temp_v = 1; break;
                    case "c": temp_v = 2; break;
                    case "d": temp_v = 3; break;
                    case "e": temp_v = 4; break;
                    case "f": temp_v = 5; break;
                    case "g": temp_v = 6; break;
                    case "h": temp_v = 7; break;
                    case "i": temp_v = 8; break;
                    case "j": temp_v = 9; break;
                    case "k": temp_v = 10; break;
                    case "l": temp_v = 11; break;
                    case "m": temp_v = 12; break;
                    case "n": temp_v = 13; break;
                    case "o": temp_v = 14; break;
                    case "p": temp_v = 15; break;
                }

                var answer = [false,false,false,false];
                if (temp_v%2/1==1) answer[0] = true;
                temp_v -= temp_v%2;
                if (temp_v%4/2==1) answer[1] = true;
                temp_v -= temp_v%4;
                if (temp_v%8/4==1) answer[2] = true;
                temp_v -= temp_v%8
                if (temp_v%16/8==1) answer[3] = true;
                temp_v -= temp_v%16;

                return answer;
            }

            function updateScreen(){
                drawScreenByHash(window.data);
            }

            var intervalStarted = false;;
            getAndUpdateScreen();

            function getAndUpdateScreen(){
                if (intervalStarted==true) return;
                    intervalStarted = true;
                    $.ajax({    
                        url: "http://127.0.0.1:8081/" + controll_buf.join(""),
                        context: document.body
                    }).done(function(data) { 
                        try{
                            eval("window.data = " + data + ".data");
                            updateScreen();
                        }catch(e){
                            console.log("Error parse" + data);
                        }
                        intervalStarted = false;

                        setTimeout(
                            function(){
                                getAndUpdateScreen();
                            },
                            timoeut_interval
                        );
                    }).fail(
                        function(){intervalStarted = false;
                            setTimeout(
                                function(){
                                    getAndUpdateScreen();
                                },
                                100
                            );
                        }
                    );

                
            }

            var timoeut_interval = 10;
            $(window).focus(function() {
                timoeut_interval = 10;
            });

            $(window).blur(function() {
                timoeut_interval = 300;
            });
        </script>
    </body>
</html>